# 数字音乐合成器（digital-synthesizer）软件测试与质量保证报告

---

## 一、测试计划

### 1.1 测试范围

覆盖项目核心功能模块，具体如下：

| 模块         | 测试重点                                                                                                |
| ------------ | ------------------------------------------------------------------------------------------------------- |
| 音符解析模块 | 音符名称→频率映射（如C4→261.63Hz）、无效音符（如H#4）处理、休止符（rest）识别                         |
| 声音合成模块 | 振荡器波形生成（正弦/方波/锯齿波/三角波）、ADSR包络控制（起音/衰减/持续/释音）、滤波器调节（低通/带通） |
| 和弦处理模块 | 多音符叠加逻辑、振幅归一化（避免失真）、空和弦（无音符）处理                                            |
| 多音轨组合   | 音轨添加/删除（含无效ID）、多轨波形混合（长度对齐、音量叠加）、音轨音域计算                             |
| 输出模块     | 音频播放（sounddevice）、WAV文件保存（scipy.io.wavfile）、空波形输出处理                                |

### 1.2 测试策略

- **单元测试**：针对核心类（`Note`、`Track`、`Oscillator`、`ADSR`等）的基础功能验证，覆盖率目标≥85%。
- **集成测试**：验证模块间协作（如 `DigitalSynthesizer`调用 `Track`生成波形并混合）。
- **异常测试**：输入非法参数（如负时长、非法音符名称）、边界值（音量0/1、时长0）。
- **回归测试**：每次代码提交后通过CI自动运行，确保历史功能不受新代码影响。

### 1.3 测试环境

| 环境类型 | 配置要求                                                                               |
| -------- | -------------------------------------------------------------------------------------- |
| 开发环境 | Windows 10+/macOS 10.15+/Ubuntu 20.04+；Python 3.9+；依赖库按 `requirements.txt`安装 |
| 测试工具 | `pytest`（单元测试）、`coverage.py`（覆盖率）、`sounddevice`（音频播放验证）     |
| 硬件要求 | 普通PC（支持音频输出）                                                                 |

### 1.4 进度安排

| 阶段         | 时间     | 目标                                                                 |
| ------------ | -------- | -------------------------------------------------------------------- |
| 单元测试编写 | 第1-2周  | 完成 `Note`、`Track`、`Oscillator`、`ADSR`等核心类的测试用例 |
| 集成测试编写 | 第3周    | 完成 `DigitalSynthesizer`多轨混合、播放/保存功能的测试用例         |
| 异常测试编写 | 第4周    | 覆盖所有输入边界条件和非法输入场景（如负时长、非法音符名称）         |
| 自动化CI集成 | 第5周    | 配置GitHub Actions，实现提交自动运行测试并检查覆盖率（目标≥85%）    |
| 回归测试     | 持续迭代 | 每次PR合并前强制通过所有测试，覆盖率不低于85%                        |

---

## 二、测试用例设计

### 2.1 单元测试用例（示例）

#### 用例1：音符解析-有效音符映射

- **测试对象**：`Note`类的 `note_midi()`方法
- **输入**：`note_name="C4"`（中央C）
- **预期输出**：MIDI编号60，频率261.63Hz（通过公式 `f=440*2^((n-69)/12)`验证）
- **实际结果**：与预期一致（参考 `tests/test_note.py`中 `test_note_midi_conversion`）。

#### 用例2：ADSR包络-振幅变化验证

- **测试对象**：`apply_adsr()`函数
- **输入**：`waveform=np.ones(1000)`（1秒全1波形），`attack_time=0.1`，`decay_time=0.1`，`sustain_level=0.5`，`release_time=0.2`
- **预期输出**：
  - 前100样本（Attack阶段）振幅递增；
  - 中间600样本（Sustain阶段）振幅稳定在0.5±0.1；
  - 最后200样本（Release阶段）振幅递减至接近0。
- **实际结果**：通过 `tests/test_adsr.py`中 `test_adsr_applies_envelope_effect`验证，符合预期。

#### 用例3：振荡器-非法波形类型处理

- **测试对象**：`oscillator()`函数
- **输入**：`wave_type="invalid_type"`，`frequency=440`，`t=np.linspace(0,1,1000)`
- **预期输出**：抛出 `ValueError`异常
- **实际结果**：`tests/test_oscillator.py`验证，正确抛出异常。

### 2.2 集成测试用例（示例）

#### 用例：多音轨混合与输出

- **测试对象**：`DigitalSynthesizer`类的 `generate_waveform()`、`play_for_preview()`、`save_to_file()`方法
- **输入**：
  - 音轨1（钢琴音色）：音符 `["C4", "E4", "G4"]`，时长 `[1,1,2]`；
  - 音轨2（小提琴音色）：音符 `["C4", "D4", "E4"]`，时长 `[0.5,0.5,1]`。
- **预期输出**：
  - 合成波形长度为两音轨最长时长对应的采样点数；
  - 播放功能调用 `sounddevice.play()`且无异常；
  - 保存的WAV文件采样率与合成器配置一致，波形数据为 `np.ndarray`类型。
- **实际结果**：通过 `tests/test_digital_synthesizer.py`中 `test_generate_waveform`、`test_play_for_preview`、`test_save_to_file`验证，符合预期。

### 2.3 异常测试用例（示例）

#### 用例：无效音符名称处理

- **测试对象**：`Note`类初始化
- **输入**：`note_name="H#4"`（非法音符名称）
- **预期输出**：调用 `note_midi()`时抛出 `ValueError`
- **实际结果**：`tests/test_note.py`中 `test_invalid_note_format`验证，正确抛出异常。

---

## 三、缺陷跟踪

### 3.1 缺陷记录

| 缺陷ID  | 模块           | 严重程度 | 优先级 | 描述                                                                                                                                                                                                                                       | 重现步骤   | 状态                  | 解决版本        |
| ------- | -------------- | -------- | ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- | --------------------- | --------------- |
| DEF-001 | adsr的参数设置 | 中       | 中     | 前两天阅读了一些文章发现adsr的参数调用错了，<br />其中ad和r的时值是固定的描述该乐器的包络特点，<br />然后s是随着duration变化的根据演奏者的时长决定，<br />而对于adsr我们只需要传入adr的值，s会自动计算，<br />adr为固定值，不需要*duration | 调用adsr时 | 已解决                | v0.1.0.20250530 |
| DEF-002 | 完善测试       | 中       | 高     | 测试覆盖率仍不够，后续将完善测试，提高覆盖率                                                                                                                                                                                               | /          | 已解决v0.1.0.20250530 |                 |

### 3.2 缺陷处理流程

1. **发现**：测试人员/CI流程发现缺陷后，通过GitHub Issues记录（标题格式：`[缺陷] 模块名：简要描述`）。
2. **分类**：根据影响范围标记严重程度（高/中/低）和优先级（紧急/高/中/低）。
3. **修复**：开发人员在 `feature/fix-def-xxx`分支修复，提交PR时关联缺陷ID。
4. **验证**：测试人员重新运行对应测试用例，确认缺陷解决后关闭Issue。
5. **回归**：修复后的代码通过CI自动运行所有测试，确保无新缺陷引入。

---

## 四、质量保证方法

### 4.1 代码审查

- **静态检查**：使用 `pylint`检查代码风格（如变量命名、注释规范），配置文件 `.pylintrc`约束规则。
- **代码走查**：每周团队会议对核心功能代码（如 `DigitalSynthesizer.generate_waveform()`）进行人工审查，确保逻辑正确性和可维护性。

### 4.2 持续集成（CI）

- **工具**：GitHub Actions（配置文件 `.github/workflows/ci.yml`）。
- **触发条件**：推送到 `dev`/`main`分支、提交PR到 `dev`分支。
- **执行步骤**：
  1. 检出代码；
  2. 安装Python 3.9+和依赖库（`requirements.txt`）；
  3. 运行 `pytest --cov=src --cov-report=term-missing`，要求覆盖率≥85%；
  4. 若测试失败或覆盖率不达标，阻止PR合并。

### 4.3 测试覆盖率监控

- **工具**：`coverage.py`（通过 `pytest --cov`集成）。
- **目标**：核心模块（`src/timbre`、`src/digital_synthesizer.py`）覆盖率≥90%，整体覆盖率≥85%。
- **报告**：每次CI运行后生成覆盖率报告，关键模块未覆盖的代码需补充测试用例。

---

**报告版本**：1.0
**生效日期**：2024-07-15
**编写团队**：digital-synthesizer开发组
